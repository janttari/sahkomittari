#!/bin/bash
echo "Tarkistetaan ohjelmistopakettien riippuvuudet..."

vaaditutpaketit=( "nginx"  "php7.3-cli" "php7.3-cgi" "php7.3-fpm" "fcgiwrap" "php7.3-sqlite3" "sqlite3" )
for i in "${vaaditutpaketit[@]}"
do
    echo "$i..."
    if [[ -z $(dpkg -l|grep  "$i") ]]; then
        echo Asennetaan "$i"
        sudo apt install -y "$i"
    fi
done

echo "websocket_server ( https://github.com/Pithikos/python-websocket-server )"
if [[ -z $(pip3 list|grep "websocket-server        0.4") ]]; then
    echo Asennetaan websocket_server
    sudo pip3 install git+https://github.com/Pithikos/python-websocket-server
fi

if [[ -z $(pip3 list|grep "watchdog") ]]; then
    echo Asennetaan watchdog
    sudo pip3 install watchdog
fi


echo Kopioidaan tiedostot...
sudo cp -R src/* /

echo "Sammutetaan palvelut..."
sudo systemctl stop sahkomittari-server
echo "Käynnistetään palvelut..."
sudo systemctl enable sahkomittari-server #palvelin joka vastaanottaa datan raspberryiltä
sudo systemctl start sahkomittari-server
sudo systemctl enable sahkomittari-ws-selaimille.service #tämä on websocket palvelija internet-selaimille
sudo systemctl start sahkomittari-ws-selaimille.service
sudo systemctl daemon-reload
echo "Asennus valmis!"
